const{json,loadState}=require("./_state");const{loadAuth,loadInbox,sha256,playerTokenFromHeader}=require("./_auth");exports.handler=async(event)=>{try{const t=playerTokenFromHeader(event);if(!t)return json(401,{error:"Missing token"});const auth=await loadAuth();const tokenHash=sha256(t);let playerId=null;for(const [pid,rec] of Object.entries(auth.players ||{})){if(rec && rec.tokenHash===tokenHash){playerId=pid;break;}}if(!playerId)return json(401,{error:"Invalid token"});const state=await loadState();const p=(state.players || []).find(x=>x.id===playerId);const teamId=p?.teamId || null;const inbox=await loadInbox();const items=(inbox.items || []).filter(m=>{if(m.target==="all")return true;if(m.target==="player" && m.playerId===playerId)return true;if(m.target==="team" && teamId && m.teamId===teamId)return true;return false;}).slice(-120).reverse();return json(200,{ok:true,items});}catch(e){console.error("playerInbox failed:",e);return json(500,{error:"Failed",detail:e?.message || "unknown"});}};