const{json,isAdmin,loadState,saveState,pushLog}=require("./_state");const {isAdminAuthed}=require("./_adminGuard");const{loadAuth,saveAuth,randCode}=require("./_auth");exports.handler=async(event)=>{try{if(!(await isAdminAuthed(event,isAdmin)))return json(401,{error:"Unauthorized"});const state=await loadState();const auth=await loadAuth();const players=state.players || [];let created=0;for(const p of players){if(!p?.id)continue;auth.players[p.id]=auth.players[p.id] ||{};if(!auth.players[p.id].code){auth.players[p.id].code=randCode();created++;}p.joinCode=auth.players[p.id].code;}pushLog(state,`Join codes generated:${created}`);await saveState(state);await saveAuth(auth);return json(200,{ok:true,created,total:players.length});}catch(e){console.error("adminGenerateJoinCodes failed:",e);return json(500,{error:"Failed",detail:e?.message || "unknown"});}};