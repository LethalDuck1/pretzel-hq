const{json,loadState}=require("./_state");const{loadAuth,loadReviews,saveReviews,sha256,playerTokenFromHeader}=require("./_auth");const{sendToSubs}=require("./_push");const crypto=require("crypto");function rid(){return "rv_"+crypto.randomBytes(8).toString("hex");}exports.handler=async(event)=>{try{const t=playerTokenFromHeader(event);if(!t)return json(401,{error:"Missing token"});const body=JSON.parse(event.body || "{}");const title=String(body.title || "Review Request").slice(0,80);const details=String(body.details || "").slice(0,2000);const link=String(body.link || "").slice(0,300);if(details.trim().length<10)return json(400,{error:"Add more details"});const state=await loadState();const auth=await loadAuth();const tokenHash=sha256(t);let playerId=null;for(const [pid,rec] of Object.entries(auth.players ||{})){if(rec && rec.tokenHash===tokenHash){playerId=pid;break;}}if(!playerId)return json(401,{error:"Invalid token"});const p=(state.players || []).find(x=>x.id===playerId);if(!p)return json(404,{error:"Player not found"});const reviews=await loadReviews();reviews.items=Array.isArray(reviews.items)? reviews.items:[];const item={id:rid(),playerId,playerName:p.name,title,details,link,status:"pending",ts:new Date().toISOString(),adminNote:""};reviews.items.push(item);if(reviews.items.length>600)reviews.items=reviews.items.slice(-600);await saveReviews(reviews);try{await sendToSubs({title:"üìù Review Requested",message:`${p.name}submitted a request`,kind:"review",ts:new Date().toISOString(),reviewId:item.id},{tags:["all"]});}catch(e){console.error("review notify push failed:",e);}return json(200,{ok:true,id:item.id});}catch(e){console.error("submitReview failed:",e);return json(500,{error:"Failed",detail:e?.message || "unknown"});}};