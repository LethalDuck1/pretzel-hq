const{json,isAdmin,loadState}=require("./_state");const {isAdminAuthed}=require("./_adminGuard");const{sendToSubs}=require("./_push");const{loadInbox,saveInbox}=require("./_auth");exports.handler=async(event)=>{try{if(!(await isAdminAuthed(event,isAdmin)))return json(401,{error:"Unauthorized"});const body=JSON.parse(event.body || "{}");const teamId=String(body.teamId || "");const title=String(body.title || "Pretzel HQ").slice(0,60);const message=String(body.message || "").slice(0,140);if(!teamId)return json(400,{error:"Missing teamId"});if(!message.trim())return json(400,{error:"Missing message"});const state=await loadState();if(!(state.teams||[]).some(t=>t.id===teamId))return json(404,{error:"Team not found"});try{const inbox=await loadInbox();inbox.items=Array.isArray(inbox.items)? inbox.items:[];inbox.items.push({id:`msg_${Date.now()}_${Math.random().toString(16).slice(2)}`,target:"team",teamId,playerId:null,title,message,ts:new Date().toISOString(),kind:"team"});if(inbox.items.length>1200)inbox.items=inbox.items.slice(-1200);await saveInbox(inbox);}catch(e){console.error("inbox write failed:",e);}const payload={title,message,kind:"team",ts:new Date().toISOString(),teamId};const res=await sendToSubs(payload,{tags:[`team:${teamId}`]});return json(200,{ok:true,...res});}catch(e){console.error("adminPushTeam failed:",e);return json(500,{error:"Failed",detail:e?.message || "unknown"});}};