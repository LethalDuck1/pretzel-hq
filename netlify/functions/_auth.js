const crypto=require("crypto");const{getStore}=require("@netlify/blobs");const STORE="pretzel-hq";const AUTH_KEY="player_auth_v1";const REV_KEY="reviews_v1";const INBOX_KEY="inbox_v1";function store(){const siteID=process.env.NETLIFY_SITE_ID || process.env.BLOBS_SITE_ID || "";const token=process.env.NETLIFY_AUTH_TOKEN || process.env.BLOBS_TOKEN || "";if(siteID && token){try{return getStore({name:STORE,siteID,token,consistency:"strong"});}catch{return getStore({name:STORE,siteID,token});}}try{return getStore({name:STORE,consistency:"strong"});}catch{return getStore(STORE);}}function sha256(s){return crypto.createHash("sha256").update(String(s)).digest("hex");}function randToken(){return crypto.randomBytes(24).toString("base64url");}function randCode(){const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let out="";for(let i=0;i<5;i++)out+=chars[Math.floor(Math.random()*chars.length)];return `PZ-${out}`;}function hashPin(pin,salt){return sha256(`${salt}:${pin}`);}async function loadAuth(){const st=store();const raw=await st.get(AUTH_KEY,{type:"json"});return raw ||{players:{}};}async function saveAuth(obj){const st=store();if(typeof st.setJSON==="function")await st.setJSON(AUTH_KEY,obj);else await st.set(AUTH_KEY,JSON.stringify(obj),{contentType:"application/json"});return obj;}async function loadReviews(){const st=store();const raw=await st.get(REV_KEY,{type:"json"});return raw ||{items:[]};}async function saveReviews(obj){const st=store();if(typeof st.setJSON==="function")await st.setJSON(REV_KEY,obj);else await st.set(REV_KEY,JSON.stringify(obj),{contentType:"application/json"});return obj;}function playerTokenFromHeader(event){return event.headers["x-player-token"] || event.headers["X-Player-Token"] || "";}module.exports={sha256,randToken,randCode,hashPin,loadAuth,saveAuth,loadReviews,saveReviews,playerTokenFromHeader};async function loadInbox(){const st=store();const raw=await st.get(INBOX_KEY,{type:"json"});return raw ||{items:[]};}async function saveInbox(obj){const st=store();if(typeof st.setJSON==="function")await st.setJSON(INBOX_KEY,obj);else await st.set(INBOX_KEY,JSON.stringify(obj),{contentType:"application/json"});return obj;}module.exports.loadInbox=loadInbox;module.exports.saveInbox=saveInbox;