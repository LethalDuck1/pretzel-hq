const{json,isAdmin,loadState}=require("./_state");const {isAdminAuthed}=require("./_adminGuard");const{loadAuth,loadReviews}=require("./_auth");const{loadSubs}=require("./_push");function diffMs(a,b){const x=new Date(a).getTime();const y=new Date(b).getTime();if(!Number.isFinite(x)|| !Number.isFinite(y))return null;return Math.max(0,y-x);}function fmt(ms){if(!ms)return "â€”";const s=Math.round(ms/1000);const m=Math.floor(s/60);const h=Math.floor(m/60);const d=Math.floor(h/24);if(d>0)return `${d}d ${h%24}h`;if(h>0)return `${h}h ${m%60}m`;return `${m}m`;}exports.handler=async(event)=>{try{if(!(await isAdminAuthed(event,isAdmin)))return json(401,{error:"Unauthorized"});const state=await loadState();const auth=await loadAuth();const reviews=await loadReviews();const players=state.players || [];const teams=state.teams || [];const alive=players.filter(p=>(p.status||"alive")==="alive").length;const authPlayers=auth.players ||{};const loggedInTotal=Object.values(authPlayers).filter(r=>r && r.lastLoginTs).length;const now=Date.now();const loggedIn24h=Object.values(authPlayers).filter(r=>{const t=r?.lastLoginTs ? new Date(r.lastLoginTs).getTime():0;return Number.isFinite(t)&& t>0 &&(now-t)<=24*60*60*1000;}).length;let subsCount=0;const byTag={};try{const subs=await loadSubs();const items=subs.items || [];subsCount=items.length;for(const it of items){for(const tag of(it.tags || [])){byTag[tag]=(byTag[tag]||0)+1;}}}catch(e){}const allReviews=reviews.items || [];const pending=allReviews.filter(r=>String(r.status||"")==="pending").length;const decided=allReviews.filter(r=>r && r.ts && r.decidedTs);const durations=decided.map(r=>diffMs(r.ts,r.decidedTs)).filter(x=>x!=null);const avg=durations.length ? Math.round(durations.reduce((a,b)=>a+b,0)/durations.length):0;return json(200,{ok:true,players:{total:players.length,alive,eliminated:players.length-alive},teams:{total:teams.length},logins:{total:loggedInTotal,last24h:loggedIn24h},push:{totalSubs:subsCount,byTagTop:Object.entries(byTag).sort((a,b)=>b[1]-a[1]).slice(0,12)},reviews:{total:allReviews.length,pending,avgTurnaround:fmt(avg)}});}catch(e){console.error("adminStats failed:",e);return json(500,{error:"Failed",detail:e?.message || "unknown"});}};