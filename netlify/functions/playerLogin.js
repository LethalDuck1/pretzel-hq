const{json,loadState}=require("./_state");const{loadAuth,saveAuth,hashPin,randToken,sha256}=require("./_auth");exports.handler=async(event)=>{try{const body=JSON.parse(event.body || "{}");const code=String(body.code || "").trim().toUpperCase();const pin=String(body.pin || "").trim();if(!/^PZ-[A-Z0-9]{5}$/.test(code))return json(400,{error:"Invalid join code"});if(!/^\d{4,12}$/.test(pin))return json(400,{error:"Invalid PIN"});const state=await loadState();const auth=await loadAuth();const p=(state.players || []).find(x=>String(x.joinCode||"").toUpperCase()===code);if(!p)return json(404,{error:"Join code not found"});auth.players[p.id]=auth.players[p.id] ||{};const rec=auth.players[p.id];if(!rec.code)rec.code=code;if(!rec.salt)rec.salt=sha256(`${p.id}:${Date.now()}:${Math.random()}`).slice(0,16);const incoming=hashPin(pin,rec.salt);if(!rec.pinHash){rec.pinHash=incoming;}else if(rec.pinHash !==incoming){return json(401,{error:"Wrong PIN"});}const t=randToken();rec.tokenHash=sha256(t);rec.lastLoginTs=new Date().toISOString();await saveAuth(auth);return json(200,{ok:true,token:t});}catch(e){console.error("playerLogin failed:",e);return json(500,{error:"Login failed",detail:e?.message || "unknown"});}};